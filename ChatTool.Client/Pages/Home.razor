@page "/"
@using Microsoft.AspNetCore.SignalR.Client
@inject NavigationManager NavigationManager
@inject Services.SignalingService SignalingService

<h3>Chat Tool</h3>

<div class="mb-3">
    <button class="btn btn-primary" @onclick="CreateRoom">Create Room</button>
</div>

<div class="mb-3">
    <label>Lobby Code</label>
    <input @bind="LobbyCode" @bind:event="oninput" placeholder="ABC123" />
    <button class="btn btn-secondary ms-2" @onclick="JoinRoom">Join</button>
</div>

@if (!string.IsNullOrEmpty(ErrorMessage))
{
    <div class="alert alert-danger">@ErrorMessage</div>
}

@code {
    private string? LobbyCode { get; set; }
    private string? ErrorMessage { get; set; }

    private async Task CreateRoom()
    {
        try
        {
            var hub = await SignalingService.GetHub();
            string code = await hub.InvokeAsync<string>("CreateRoom");
            NavigationManager.NavigateTo($"/chat/{code}");
        }
        catch (Exception exception)
        {
            ErrorMessage = exception.Message;
        }
    }

    private async Task JoinRoom()
    {
        ErrorMessage = null;

        if (string.IsNullOrWhiteSpace(LobbyCode))
        {
            ErrorMessage = "Please enter a lobby code to join.";
            return;
        }

        var hub = await SignalingService.GetHub();
        bool ok = await hub.InvokeAsync<bool>("JoinRoom", LobbyCode);

        if (!ok)
        {
            ErrorMessage = "Room not found or already full.";
            return;
        }

        NavigationManager.NavigateTo($"/chat/{LobbyCode.Trim().ToUpperInvariant()}");
    }
}